// 1. 数据初始化 (增加了一个简单的 ID 生成器)
let state = JSON.parse(localStorage.getItem('myProjectData')) || {
    points: 0,
    projects: []
};

// 2. 保存并刷新界面
function saveData() {
    localStorage.setItem('myProjectData', JSON.stringify(state));
    renderList();
    updatePoints();
}

function updatePoints() {
    document.getElementById('totalPoints').innerText = state.points;
}

// 3. 【新增】新建总项目功能
window.addProject = () => {
    const title = prompt("请输入总项目名称:");
    if (title) {
        const newProj = {
            id: Date.now(), // 使用时间戳作为唯一ID
            title: title,
            start: new Date().toISOString().split('T')[0], // 默认今天
            end: "",
            type: 'project',
            children: []
        };
        state.projects.push(newProj);
        saveData();
    }
};

// 4. 【新增】寻找特定 ID 的项目 (递归算法)
function findItemById(items, id) {
    for (let item of items) {
        if (item.id === id) return item;
        if (item.children && item.children.length > 0) {
            let found = findItemById(item.children, id);
            if (found) return found;
        }
    }
    return null;
}

// 5. 【新增】添加子项功能
window.addChild = (parentId) => {
    const parent = findItemById(state.projects, parentId);
    if (parent) {
        const title = prompt(`为「${parent.title}」添加子项名称:`);
        if (title) {
            const isTask = confirm("这是一个需要打卡的任务吗？\n(确定: 打卡任务, 取消: 普通子项目)");
            const newChild = {
                id: Date.now(),
                title: title,
                type: isTask ? 'checkin' : 'project',
                points: isTask ? 10 : 0,
                children: []
            };
            parent.children.push(newChild);
            saveData();
        }
    }
};

// 6. 打卡功能
window.doCheckIn = (id) => {
    const item = findItemById(state.projects, id);
    if (item) {
        state.points += (item.points || 5);
        alert(`打卡成功！获得 ${item.points || 5} 积分。`);
        saveData();
    }
};

// 7. 【新增】删除功能 (新手调试必备)
window.deleteItem = (id) => {
    if (confirm("确定要删除这个项目及其所有子项吗？")) {
        const removeRecursive = (list) => {
            return list.filter(item => {
                if (item.id === id) return false;
                if (item.children) item.children = removeRecursive(item.children);
                return true;
            });
        };
        state.projects = removeRecursive(state.projects);
        saveData();
    }
};

// 8. 渲染列表 (在原有基础上增加了“删除”按钮显示)
function renderList() {
    const treeContainer = document.getElementById('projectTree');
    if (!treeContainer) return;
    treeContainer.innerHTML = '';

    if (state.projects.length === 0) {
        treeContainer.innerHTML = '<p class="text-gray-400 text-center py-4">还没有项目，点击上方按钮开始吧！</p>';
    }

    const createNode = (item, depth = 0) => {
        const div = document.createElement('div');
        div.className = `p-3 my-2 ${depth > 0 ? 'sub-project' : 'project-card bg-gray-50 rounded shadow-sm'}`;
        
        let actionBtn = '';
        if(item.type === 'checkin') {
            actionBtn = `<button onclick="doCheckIn(${item.id})" class="text-xs bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600">打卡</button>`;
        }

        div.innerHTML = `
            <div class="flex justify-between items-center px-2">
                <div class="flex-1">
                    <span class="font-medium ${item.type === 'checkin' ? 'text-green-700' : 'text-gray-800'}">${item.title}</span>
                    <span class="text-xs text-gray-400 ml-2">${item.start || ''}</span>
                </div>
                <div class="flex space-x-2">
                    ${actionBtn}
                    <button onclick="addChild(${item.id})" class="text-blue-500 text-xs hover:underline">+子项</button>
                    <button onclick="deleteItem(${item.id})" class="text-red-400 text-xs hover:text-red-600">删除</button>
                </div>
            </div>
        `;
        
        if (item.children) {
            item.children.forEach(child => div.appendChild(createNode(child, depth + 1)));
        }
        return div;
    };

    state.projects.forEach(p => treeContainer.appendChild(createNode(p)));
}

// 9. 视图切换与日历
window.switchView = (view) => {
    document.getElementById('listView').classList.toggle('hidden', view !== 'list');
    document.getElementById('calendarView').classList.toggle('hidden', view !== 'calendar');
    if(view === 'calendar') renderCalendar();
};

function renderCalendar() {
    const calendarEl = document.getElementById('calendar');
    // 扁平化所有带日期的项目用于显示
    const events = [];
    const extractEvents = (list) => {
        list.forEach(p => {
            if (p.start) events.push({ title: p.title, start: p.start, color: p.type === 'checkin' ? '#10b981' : '#3b82f6' });
            if (p.children) extractEvents(p.children);
        });
    };
    extractEvents(state.projects);
    
    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        events: events,
        locale: 'zh-cn'
    });
    calendar.render();
}

// 初始运行
renderList();
updatePoints();
