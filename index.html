<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¡¹ç›®ä¸æ‰“å¡ç³»ç»Ÿ - å®Œæ•´ä¿®å¤ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <style>
        .project-card { border-left: 4px solid #3b82f6; transition: all 0.2s; }
        .sub-project { margin-left: 1.5rem; border-left: 1px dashed #cbd5e1; padding-left: 1rem; }
        .checkin-task { border-left-color: #10b981; bg-color: #f0fdf4; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">

    <div class="container mx-auto max-w-4xl p-4 md:p-8">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-extrabold text-slate-800 tracking-tight">ğŸš€ é¡¹ç›®ç®¡ç†ç³»ç»Ÿ</h1>
                <p class="text-slate-500">æ— é™å±‚çº§ Â· è‡ªåŠ¨å…³è”æ—¥å† Â· ç§¯åˆ†æ‰“å¡</p>
            </div>
            <div class="flex bg-white rounded-lg shadow-sm border p-1">
                <button onclick="window.switchView('list')" class="px-4 py-2 rounded-md hover:bg-slate-100 transition">åˆ—è¡¨æ¨¡å¼</button>
                <button onclick="window.switchView('calendar')" class="px-4 py-2 rounded-md hover:bg-slate-100 transition">æ—¥å†æ¨¡å¼</button>
            </div>
        </header>

        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-6 rounded-2xl mb-8 shadow-lg text-white">
            <div class="text-blue-100 text-sm font-medium uppercase tracking-wider">å½“å‰ä¸ªäººæ€»ç§¯åˆ†</div>
            <div class="text-4xl font-black mt-1"><span id="totalPoints">0</span> <span class="text-2xl font-normal opacity-80">â­</span></div>
        </div>

        <div id="listView" class="space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold text-slate-700">é¡¹ç›®åˆ—è¡¨</h2>
                <button onclick="window.addProject()" class="bg-blue-600 text-white px-5 py-2.5 rounded-xl font-semibold shadow-md hover:bg-blue-700 active:scale-95 transition">
                    + æ–°å»ºæ€»é¡¹ç›®
                </button>
            </div>
            <div id="projectTree" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 min-h-[200px]">
                </div>
        </div>

        <div id="calendarView" class="hidden animate-fadeIn">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <div class="mb-4 text-sm text-slate-500 italic">æç¤ºï¼šç›´æ¥ç‚¹å‡»æ—¥å†ä¸Šçš„æ—¥æœŸå¯ä»¥å¿«é€Ÿåˆ›å»ºé¡¹ç›®</div>
                <div id="calendar"></div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. æ•°æ®ç®¡ç† ---
        let state = JSON.parse(localStorage.getItem('myProjectApp_v2')) || {
            points: 0,
            projects: []
        };

        function saveData() {
            localStorage.setItem('myProjectApp_v2', JSON.stringify(state));
            renderList();
            updatePoints();
        }

        function updatePoints() {
            const el = document.getElementById('totalPoints');
            if(el) el.innerText = state.points;
        }

        // --- 2. æ ¸å¿ƒé€»è¾‘ï¼šé€’å½’æŸ¥æ‰¾é¡¹ç›® ---
        function findItemById(items, id) {
            for (let item of items) {
                if (item.id === id) return item;
                if (item.children && item.children.length > 0) {
                    let found = findItemById(item.children, id);
                    if (found) return found;
                }
            }
            return null;
        }

        // --- 3. äº¤äº’åŠŸèƒ½ (å¼ºåˆ¶ç»‘å®šåˆ° window å¯¹è±¡) ---

        // æ–°å»ºä¸»é¡¹ç›®
        window.addProject = (defaultDate = null) => {
            const title = prompt("è¯·è¾“å…¥æ–°é¡¹ç›®åç§°:");
            if (!title) return;
            
            const newProj = {
                id: Date.now(),
                title: title,
                start: defaultDate || new Date().toISOString().split('T')[0],
                type: 'project',
                children: []
            };
            state.projects.push(newProj);
            saveData();
        };

        // æ·»åŠ å­é¡¹
        window.addChild = (parentId) => {
            const parent = findItemById(state.projects, parentId);
            if (!parent) return;

            const title = prompt(`ä¸ºã€Œ${parent.title}ã€æ·»åŠ å­é¡¹åç§°:`);
            if (!title) return;

            const isTask = confirm("è¿™æ˜¯ä¸€ä¸ªæ‰“å¡ä»»åŠ¡å—ï¼Ÿ\n(ç¡®å®š: æ¯å¤©æ‰“å¡é¢†ç§¯åˆ†, å–æ¶ˆ: æ™®é€šé¡¹ç›®èŠ‚ç‚¹)");
            const newChild = {
                id: Date.now(),
                title: title,
                type: isTask ? 'checkin' : 'project',
                points: isTask ? 10 : 0,
                children: []
            };
            
            if(!parent.children) parent.children = [];
            parent.children.push(newChild);
            saveData();
        };

        // æ‰“å¡
        window.doCheckIn = (id) => {
            const item = findItemById(state.projects, id);
            if (item) {
                state.points += (item.points || 5);
                alert(`ğŸ‰ æˆåŠŸæ‰“å¡ï¼š${item.title}\nç§¯åˆ† +${item.points || 5}`);
                saveData();
            }
        };

        // åˆ é™¤
        window.deleteItem = (id) => {
            if (confirm("ç¡®å®šè¦å½»åº•åˆ é™¤è¯¥é¡¹ç›®åŠå…¶æ‰€æœ‰å­é¡¹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚")) {
                const filterList = (list) => {
                    return list.filter(item => {
                        if (item.id === id) return false;
                        if (item.children) item.children = filterList(item.children);
                        return true;
                    });
                };
                state.projects = filterList(state.projects);
                saveData();
            }
        };

        // --- 4. ç•Œé¢æ¸²æŸ“ ---

        function renderList() {
            const container = document.getElementById('projectTree');
            if (!container) return;
            container.innerHTML = '';

            if (state.projects.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-slate-400">
                        <p class="text-lg">æš‚æ— é¡¹ç›®</p>
                        <p class="text-sm">ç‚¹å‡»å³ä¸Šè§’â€œæ–°å»ºæ€»é¡¹ç›®â€æŒ‰é’®å¼€å§‹å§ï¼</p>
                    </div>`;
                return;
            }

            const createHTML = (item, depth = 0) => {
                const node = document.createElement('div');
                node.className = `p-4 my-2 rounded-xl border ${depth > 0 ? 'sub-project bg-white' : 'project-card bg-slate-50 shadow-sm'}`;
                if(item.type === 'checkin') node.classList.add('checkin-task', 'bg-emerald-50/30', 'border-emerald-100');

                const btnCheckIn = item.type === 'checkin' 
                    ? `<button onclick="window.doCheckIn(${item.id})" class="bg-emerald-500 text-white px-3 py-1 rounded-lg text-xs font-bold hover:bg-emerald-600 transition">æ‰“å¡</button>` 
                    : '';

                node.innerHTML = `
                    <div class="flex justify-between items-center group">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-slate-700">${item.title}</span>
                            ${item.start ? `<span class="text-[10px] bg-slate-200 text-slate-600 px-1.5 py-0.5 rounded">${item.start}</span>` : ''}
                        </div>
                        <div class="flex items-center gap-3 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity">
                            ${btnCheckIn}
                            <button onclick="window.addChild(${item.id})" class="text-blue-500 text-xs font-semibold hover:text-blue-700">æ·»åŠ å­é¡¹</button>
                            <button onclick="window.deleteItem(${item.id})" class="text-rose-400 hover:text-rose-600">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>
                `;

                if (item.children && item.children.length > 0) {
                    item.children.forEach(child => node.appendChild(createHTML(child, depth + 1)));
                }
                return node;
            };

            state.projects.forEach(p => container.appendChild(createHTML(p)));
        }

        // --- 5. è§†å›¾åˆ‡æ¢ä¸æ—¥å†åˆå§‹åŒ– ---

        window.switchView = (view) => {
            document.getElementById('listView').classList.toggle('hidden', view !== 'list');
            document.getElementById('calendarView').classList.toggle('hidden', view !== 'calendar');
            if(view === 'calendar') renderCalendar();
        };

        let calendarObj = null;
        function renderCalendar() {
            const calendarEl = document.getElementById('calendar');
            const events = [];
            const extract = (list) => {
                list.forEach(p => {
                    if (p.start) events.push({ 
                        title: (p.type === 'checkin' ? 'ğŸ“Œ ' : 'ğŸ“ ') + p.title, 
                        start: p.start, 
                        backgroundColor: p.type === 'checkin' ? '#10b981' : '#3b82f6',
                        borderColor: 'transparent'
                    });
                    if (p.children) extract(p.children);
                });
            };
            extract(state.projects);
            
            if(calendarObj) calendarObj.destroy();
            
            calendarObj = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'zh-cn',
                events: events,
                headerToolbar: { left: 'prev,next today', center: 'title', right: '' },
                // è§£å†³ç‚¹å‡»æ—¥å†æ·»åŠ é¡¹ç›®çš„é—®é¢˜
                dateClick: function(info) {
                    if(confirm(`è¦åœ¨ ${info.dateStr} è¿™ä¸€å¤©æ–°å»ºé¡¹ç›®å—ï¼Ÿ`)) {
                        window.addProject(info.dateStr);
                    }
                }
            });
            calendarObj.render();
        }

        // åˆå§‹åŒ–è¿è¡Œ
        document.addEventListener('DOMContentLoaded', () => {
            renderList();
            updatePoints();
